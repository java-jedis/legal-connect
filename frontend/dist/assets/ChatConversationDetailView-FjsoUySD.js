import{C as re,a as fe}from"./ChatConversationList-BF17EnVr.js";import{_ as ie,V as ve,u as ge,f as C,l as g,D as V,A as he,G as O,M as we,c as r,b as t,m as _,s as W,x as pe,y as ke,t as R,n as ne,F as L,g as D,r as ye,o as i,i as Ce,v as be,w as Me,H as xe,z as Ie,a as se}from"./index-rvQoOiZL.js";const Se={class:"conversation-header"},_e={class:"participant-info"},Re={class:"participant-details"},Le={class:"participant-name"},Te={class:"connection-status"},Ee={class:"status-text"},Be={key:0,class:"connection-banner"},De=["disabled"],$e={key:0,class:"load-more-container"},Ae={key:1,class:"loading-more"},Ne={key:2,class:"messages-loading"},ze={key:3,class:"messages-empty"},Ue={key:0,class:"date-separator"},Ve={class:"date-text"},je={class:"message-bubble"},He={key:0,class:"sender-name"},Fe={class:"message-content"},Pe={class:"message-text"},We={class:"message-footer"},Ye=["datetime","title"],qe=["title"],Oe={key:0,class:"status-icon status-icon--sent",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},Ge={key:1,class:"status-icon status-icon--delivered",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},Ke={key:2,class:"status-icon status-icon--read"},Qe={key:3,class:"status-icon status-icon--sending",viewBox:"0 0 24 24"},Je={key:5,class:"messages-error"},Xe=["disabled"],Ze={__name:"ChatConversationView",props:{conversationId:{type:String,required:!0},conversation:{type:Object,default:null}},setup(I){const v=I,l=ve(),n=ge(),S=C(null),m=C(null),b=C(null),f=C(!1),p=C(!1),k=C(!0),M=C(0),T=C(null),y=g(()=>l.getConversationMessages(v.conversationId)||[]),G=g(()=>l.isLoadingMessages),j=g(()=>l.isLoadingMoreMessages),x=g(()=>l.error),E=g(()=>l.isConnected),$=g(()=>l.messagePagination[v.conversationId]||{}),H=g(()=>$.value.hasMore||!1),K=g(()=>{if(v.conversation)return F(v.conversation);const s=l.conversations.find(e=>e.id===v.conversationId);return s?F(s):"Unknown User"}),Q=g(()=>x.value?x.value.includes("after multiple attempts")?"Failed to load messages after multiple attempts":x.value.includes("network")||x.value.includes("timeout")?"Network error. Please check your connection and try again.":x.value:"Failed to load messages"),F=s=>s.participantTwoName||s.otherParticipantName||s.participantName||"Unknown User",A=s=>{var e;return s.senderId===((e=n.userInfo)==null?void 0:e.id)},B=(s,e)=>e===0?!0:y.value[e-1].senderId!==s.senderId||c(s,e),Y=(s,e)=>{if(e===y.value.length-1)return!0;const u=y.value[e+1];return u.senderId!==s.senderId||c(u,e+1)},c=(s,e)=>{if(e===0)return!0;const u=y.value[e-1],o=new Date(s.createdAt),w=new Date(u.createdAt);return o.toDateString()!==w.toDateString()},d=s=>{var u;const e=(u=n.userInfo)==null?void 0:u.id;return s.senderId!==e?null:s.isRead?"read":s.tempId&&l.isSendingMessage?"sending":"delivered"},N=s=>{switch(d(s)){case"sending":return"Sending...";case"sent":return"Sent";case"delivered":return"Delivered";case"read":return"Read";default:return""}},z=s=>!s||new Date(s).getTime()===0?"Invalid time":new Date(s).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!1}),J=s=>{const e=new Date(s),u=new Date,o=new Date(u);return o.setDate(o.getDate()-1),e.toDateString()===u.toDateString()?"Today":e.toDateString()===o.toDateString()?"Yesterday":e.toLocaleDateString([],{weekday:"long",year:"numeric",month:"long",day:"numeric"})},oe=s=>new Date(s).toLocaleString(),a=async()=>{if(j.value||!H.value)return;const s=m.value;s&&(M.value=s.scrollTop),await l.fetchMoreMessages(v.conversationId),await O(),s&&(s.scrollTop=M.value)},h=async()=>{if(!f.value){f.value=!0;try{await l.manualReconnect()}catch(s){console.error("Failed to reconnect:",s)}finally{f.value=!1}}},X=async()=>{if(!p.value){p.value=!0,l.clearError();try{await l.fetchConversationMessages(v.conversationId)}catch(s){console.error("Retry load messages failed:",s)}finally{p.value=!1}}},q=(s=!0)=>{const e=m.value;if(e){const u=()=>{const o={top:e.scrollHeight,behavior:s?"smooth":"auto"};console.log("Scrolling to bottom:",{scrollHeight:e.scrollHeight,clientHeight:e.clientHeight,currentScrollTop:e.scrollTop}),e.scrollTo(o)};u(),setTimeout(u,10)}},le=()=>{const s=m.value;if(!s)return;const{scrollTop:e,scrollHeight:u,clientHeight:o}=s,w=u-e-o<100;k.value=w,ce(),requestAnimationFrame(()=>{s.scrollHeight>s.clientHeight&&(s.style.overflowY="auto")})},me=async s=>{var o;if(!s||s.length===0)return;const e=(o=n.userInfo)==null?void 0:o.id,u=s.filter(w=>!w.isRead&&w.senderId!==e);u.length>0&&(console.log(`Auto-marking ${u.length} new messages as read`),u.forEach(w=>{l.updateMessageReadStatus(v.conversationId,w.id,!0)}),l.isConnected&&u.forEach(w=>{try{l.markMessageAsRead(w.id)}catch(P){console.warn("Failed to send read status via WebSocket:",P)}}),await l.markConversationAsRead(v.conversationId))},ce=async()=>{var w;if(!v.conversationId||!m.value)return;const s=(w=n.userInfo)==null?void 0:w.id,e=m.value,u=e.querySelectorAll(".message-wrapper"),o=[];u.forEach((P,ae)=>{const Z=y.value[ae];if(!Z||Z.isRead||Z.senderId===s)return;const ee=P.getBoundingClientRect(),te=e.getBoundingClientRect();ee.top>=te.top-50&&ee.bottom<=te.bottom+50&&ee.left>=te.left&&ee.right<=te.right&&o.push(Z)}),o.length>0&&(console.log(`Auto-marking ${o.length} visible messages as read`),o.forEach(P=>{l.updateMessageReadStatus(v.conversationId,P.id,!0)}),l.isConnected&&(clearTimeout(T.value),T.value=setTimeout(()=>{o.forEach(P=>{try{l.markMessageAsRead(P.id)}catch(ae){console.warn("Failed to send read status via WebSocket:",ae)}})},500)),await l.markConversationAsRead(v.conversationId))};V(()=>y.value.length,async(s,e)=>{if(s>e&&k.value){const u=y.value.slice(e);await me(u),O(()=>{q()})}}),V(()=>y.value,async s=>{s&&s.length>0&&await ce()},{deep:!0}),V(()=>v.conversationId,async s=>{s&&(k.value=!0,await l.fetchConversationMessages(s),await l.markConversationAsRead(s),await O(),q(!1),setTimeout(()=>{q(!1)},100))},{immediate:!0});const de=s=>{const e=s.detail;console.log("ChatConversationView: Real-time message received:",e),e.conversationId===v.conversationId&&k.value&&O(()=>{q()})},U=s=>{var u;const e=s.detail;if(console.log("ChatConversationView: Real-time read status update:",e),e.conversationId===v.conversationId||e.messageId&&y.value.some(o=>o.id===e.messageId)){if(e.messageId){const o=y.value.find(w=>w.id===e.messageId);o&&!o.isRead&&(console.log(`Updating read status for message ${e.messageId} in UI`),l.updateMessageReadStatus(v.conversationId,e.messageId,!0))}if(e.conversationId&&!e.messageId){console.log(`All messages in conversation ${e.conversationId} marked as read`);const o=(u=n.userInfo)==null?void 0:u.id;y.value.forEach(w=>{!w.isRead&&w.senderId===o&&l.updateMessageReadStatus(v.conversationId,w.id,!0)})}}},ue=s=>{const e=s.detail;console.log("ChatConversationView: WebSocket reconnection status:",e),e.success&&!e.reconnecting&&(console.log("WebSocket reconnected successfully, refreshing conversation messages..."),v.conversationId&&l.fetchConversationMessages(v.conversationId))};return he(async()=>{m.value&&m.value.addEventListener("scroll",le),window.addEventListener("websocket-message",de),window.addEventListener("websocket-message-read",U),window.addEventListener("websocket-conversation-read",U),window.addEventListener("websocket-read-status-update",U),window.addEventListener("cross-tab-message-read",U),window.addEventListener("websocket-reconnection-status",ue),v.conversationId&&y.value.length===0&&(await l.fetchConversationMessages(v.conversationId),await l.markConversationAsRead(v.conversationId),await O(),q(!1),setTimeout(()=>{q(!1)},100))}),we(()=>{m.value&&m.value.removeEventListener("scroll",le),window.removeEventListener("websocket-message",de),window.removeEventListener("websocket-message-read",U),window.removeEventListener("websocket-conversation-read",U),window.removeEventListener("websocket-read-status-update",U),window.removeEventListener("cross-tab-message-read",U),window.removeEventListener("websocket-reconnection-status",ue),T.value&&clearTimeout(T.value)}),(s,e)=>{const u=ke("router-link");return i(),r("div",{class:"chat-conversation-view",ref_key:"conversationRef",ref:S},[t("div",Se,[t("div",_e,[W(u,{to:"/chat",class:"back-button",title:"Back to Messages"},{default:pe(()=>e[0]||(e[0]=[t("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[t("path",{d:"M15 18l-6-6 6-6",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)])),_:1,__:[0]}),e[1]||(e[1]=t("div",{class:"participant-avatar"},[t("svg",{class:"avatar-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})])],-1)),t("div",Re,[t("h2",Le,R(K.value),1),t("div",Te,[t("span",{class:ne(["status-indicator",{"status-indicator--connected":E.value,"status-indicator--disconnected":!E.value}])},null,2),t("span",Ee,R(E.value?"Online":"Offline"),1)])])]),E.value?_("",!0):(i(),r("div",Be,[e[4]||(e[4]=t("svg",{class:"warning-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[t("path",{d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)),e[5]||(e[5]=t("span",null,"Messages may not be delivered in real-time",-1)),t("button",{onClick:h,class:"reconnect-btn",disabled:f.value},[f.value?(i(),r(L,{key:0},[e[2]||(e[2]=t("svg",{class:"loading-spinner-small",viewBox:"0 0 24 24"},[t("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"2",fill:"none",opacity:"0.3"}),t("path",{d:"M12 2a10 10 0 0 1 10 10",stroke:"currentColor","stroke-width":"2",fill:"none"})],-1)),e[3]||(e[3]=D(" Reconnecting... "))],64)):(i(),r(L,{key:1},[D("Reconnect")],64))],8,De)]))]),t("div",{class:"messages-container",ref_key:"messagesContainer",ref:m},[H.value&&!j.value?(i(),r("div",$e,[t("button",{onClick:a,class:"load-more-btn"},e[6]||(e[6]=[t("svg",{class:"load-more-icon",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 15l7-7 7 7"})],-1),D(" Load earlier messages ")]))])):_("",!0),j.value?(i(),r("div",Ae,[W(re,{type:"message-list",count:3,animated:!0,size:"small"})])):_("",!0),G.value&&y.value.length===0?(i(),r("div",Ne,[W(re,{type:"message-list",count:6,animated:!0})])):y.value.length===0?(i(),r("div",ze,e[7]||(e[7]=[t("svg",{class:"empty-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[t("path",{d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1),t("p",null,"No messages yet",-1),t("span",null,"Start the conversation by sending a message below",-1)]))):(i(),r("div",{key:4,class:"messages-list",ref_key:"messagesList",ref:b},[(i(!0),r(L,null,ye(y.value,(o,w)=>(i(),r("div",{key:o.id,class:ne(["message-wrapper",{"message-wrapper--own":A(o),"message-wrapper--other":!A(o),"message-wrapper--first-in-group":B(o,w),"message-wrapper--last-in-group":Y(o,w)}])},[c(o,w)?(i(),r("div",Ue,[t("span",Ve,R(J(o.createdAt)),1)])):_("",!0),t("div",je,[!A(o)&&B(o,w)?(i(),r("div",He,R(o.senderName),1)):_("",!0),t("div",Fe,[t("p",Pe,R(o.content),1)]),t("div",We,[t("time",{class:"message-time",datetime:o.createdAt,title:oe(o.createdAt)},R(z(o.createdAt)),9,Ye),A(o)&&d(o)?(i(),r("div",{key:0,class:"message-status",title:N(o)},[d(o)==="sent"?(i(),r("svg",Oe,e[8]||(e[8]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"},null,-1)]))):d(o)==="delivered"?(i(),r("svg",Ge,e[9]||(e[9]=[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"},null,-1)]))):d(o)==="read"?(i(),r("div",Ke,e[10]||(e[10]=[t("svg",{class:"read-check read-check--first",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})],-1),t("svg",{class:"read-check read-check--second",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M5 13l4 4L19 7"})],-1)]))):(i(),r("svg",Qe,e[11]||(e[11]=[t("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"2",fill:"none",opacity:"0.3"},null,-1),t("path",{d:"M12 2a10 10 0 0 1 10 10",stroke:"currentColor","stroke-width":"2",fill:"none"},null,-1)])))],8,qe)):_("",!0)])])],2))),128))],512)),x.value?(i(),r("div",Je,[e[14]||(e[14]=t("svg",{class:"error-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[t("path",{d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)),t("p",null,R(Q.value),1),t("button",{onClick:X,class:"retry-btn",disabled:p.value},[p.value?(i(),r(L,{key:0},[e[12]||(e[12]=t("svg",{class:"loading-spinner-small",viewBox:"0 0 24 24"},[t("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"2",fill:"none",opacity:"0.3"}),t("path",{d:"M12 2a10 10 0 0 1 10 10",stroke:"currentColor","stroke-width":"2",fill:"none"})],-1)),e[13]||(e[13]=D(" Retrying... "))],64)):(i(),r(L,{key:1},[D("Try again")],64))],8,Xe)])):_("",!0)],512)],512)}}},et=ie(Ze,[["__scopeId","data-v-18da84ed"]]),tt={class:"chat-message-input"},st={key:0,class:"error-banner"},nt=["disabled"],ot={class:"input-container"},at={class:"textarea-wrapper"},rt=["placeholder","disabled","maxlength"],it=["disabled","aria-label"],lt={key:0,class:"loading-spinner",viewBox:"0 0 24 24"},ct={key:1,class:"send-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},dt={key:0,class:"validation-error"},ut={__name:"ChatMessageInput",props:{placeholder:{type:String,default:"Type a message..."},maxLength:{type:Number,default:2e3},disabled:{type:Boolean,default:!1},isSending:{type:Boolean,default:!1},error:{type:String,default:null},autoResize:{type:Boolean,default:!0},maxRows:{type:Number,default:6}},emits:["send","input","focus","blur"],setup(I,{expose:v,emit:l}){const n=I,S=l,m=C(null),b=C(""),f=C(""),p=C(""),k=C(!1),M=g(()=>!n.isSending&&!n.disabled&&b.value.trim().length>0&&b.value.length<=n.maxLength&&!T.value),T=g(()=>!!f.value);g(()=>{const c=n.maxLength-b.value.length;return c<=100&&c>0}),g(()=>b.value.length>n.maxLength);const y=g(()=>n.error?n.error.includes("network")||n.error.includes("timeout")?"Network error. Please check your connection and try again.":n.error.includes("rate limit")?"You're sending messages too quickly. Please wait a moment.":n.error.includes("unauthorized")?"You're not authorized to send messages in this conversation.":n.error:""),G=g(()=>n.error&&p.value&&(n.error.includes("network")||n.error.includes("timeout")||n.error.includes("Failed to send"))),j=c=>{const d=c.trim();return d.length===0?"Message cannot be empty":d.length>n.maxLength?`Message cannot exceed ${n.maxLength} characters`:/<script|javascript:|data:/i.test(c)?"Message contains invalid content":""},x=c=>{const d=c.target.value;f.value&&(f.value=""),n.autoResize&&B(),S("input",d)},E=c=>{c.key==="Enter"&&!c.shiftKey?(c.preventDefault(),H()):c.key==="Escape"&&(c.preventDefault(),F())},$=()=>{O(()=>{n.autoResize&&B()})},H=async()=>{if(!M.value)return;const c=b.value.trim(),d=j(c);if(d){f.value=d;return}p.value=c;const N=b.value;b.value="",f.value="",n.autoResize&&Y();try{S("send",c)}catch(z){b.value=N,console.error("Error sending message:",z)}},K=async()=>{if(!(!p.value||k.value)){k.value=!0;try{S("send",p.value),p.value=""}catch(c){console.error("Error retrying message:",c)}finally{k.value=!1}}},Q=()=>{p.value=""},F=()=>{b.value="",f.value="",p.value="",n.autoResize&&Y()},A=()=>{m.value&&m.value.focus()},B=()=>{if(!m.value||!n.autoResize)return;const c=m.value;c.style.height="auto";const d=c.scrollHeight,z=parseInt(getComputedStyle(c).lineHeight)*n.maxRows,J=Math.min(d,z);c.style.height=`${J}px`,c.style.overflowY=d>z?"auto":"hidden"},Y=()=>{!m.value||!n.autoResize||(m.value.style.height="auto",m.value.style.overflowY="hidden")};return V(()=>n.error,c=>{c||(p.value="",k.value=!1)}),V(()=>n.isSending,c=>{!c&&!n.error&&(p.value="")}),v({focusInput:A,clearInput:F}),(c,d)=>(i(),r("div",tt,[I.error?(i(),r("div",st,[d[4]||(d[4]=t("svg",{class:"error-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[t("path",{d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)),t("span",null,R(y.value),1),G.value?(i(),r("button",{key:0,onClick:K,class:"retry-btn",disabled:k.value},[k.value?(i(),r(L,{key:0},[d[1]||(d[1]=t("svg",{class:"loading-spinner-small",viewBox:"0 0 24 24"},[t("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"2",fill:"none",opacity:"0.3"}),t("path",{d:"M12 2a10 10 0 0 1 10 10",stroke:"currentColor","stroke-width":"2",fill:"none"})],-1)),d[2]||(d[2]=D(" Retrying... "))],64)):(i(),r(L,{key:1},[D("Retry")],64))],8,nt)):_("",!0),t("button",{onClick:Q,class:"dismiss-btn","aria-label":"Dismiss error"},d[3]||(d[3]=[t("svg",{class:"dismiss-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[t("path",{d:"M6 18L18 6M6 6l12 12",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)]))])):_("",!0),t("form",{onSubmit:Me(H,["prevent"]),class:"message-form"},[t("div",ot,[t("div",at,[Ce(t("textarea",{ref_key:"messageTextarea",ref:m,"onUpdate:modelValue":d[0]||(d[0]=N=>b.value=N),placeholder:I.placeholder,disabled:I.isSending||I.disabled,maxlength:I.maxLength,class:ne(["message-textarea",{"message-textarea--error":T.value,"message-textarea--disabled":I.isSending||I.disabled}]),rows:"1",onKeydown:E,onInput:x,onPaste:$,"aria-label":"Type your message"},null,42,rt),[[be,b.value]])]),t("button",{type:"submit",class:ne(["send-button",{"send-button--disabled":!M.value,"send-button--sending":I.isSending}]),disabled:!M.value,"aria-label":I.isSending?"Sending message...":"Send message"},[I.isSending?(i(),r("svg",lt,d[5]||(d[5]=[t("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor","stroke-width":"2",fill:"none",opacity:"0.3"},null,-1),t("path",{d:"M12 2a10 10 0 0 1 10 10",stroke:"currentColor","stroke-width":"2",fill:"none"},null,-1)]))):(i(),r("svg",ct,d[6]||(d[6]=[t("path",{d:"M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])))],10,it)]),f.value?(i(),r("div",dt,R(f.value),1)):_("",!0)],32)]))}},vt=ie(ut,[["__scopeId","data-v-6be4786d"]]),gt={class:"chat-conversation-layout"},ht={class:"chat-sidebar"},wt={class:"sidebar-content"},mt={class:"chat-main"},ft={key:0,class:"loading-container"},pt={key:1,class:"error-container"},kt={class:"error-content"},yt={class:"error-actions"},Ct=["disabled"],bt={class:"chat-input-container"},Mt={class:"right-actions-sidebar"},xt={class:"action-buttons"},It={__name:"ChatConversationDetailView",setup(I){const v=xe(),l=Ie(),n=ve(),S=ge(),m=C(null),b=C(null),f=C(!0),p=C(!1),k=C(null),M=g(()=>v.params.id),T=g(()=>n.sortedConversations),y=g(()=>n.isLoading),G=g(()=>{var a;return((a=S.userInfo)==null?void 0:a.role)==="LAWYER"||S.userType==="lawyer"}),j=g(()=>{var a;return((a=S.userInfo)==null?void 0:a.role)==="USER"||S.userType==="user"}),x=g(()=>n.conversations.find(a=>a.id===M.value)||null),E=g(()=>x.value?F(x.value):"Unknown User"),$=g(()=>M.value?!f.value&&!x.value&&n.conversations.length>0?"not_found":n.error&&!f.value?"load_failed":null:"invalid_id"),H=g(()=>{switch($.value){case"invalid_id":return"Invalid Conversation";case"not_found":return"Conversation Not Found";case"load_failed":return"Failed to Load Conversation";default:return"Error"}}),K=g(()=>{switch($.value){case"invalid_id":return"The conversation ID is invalid or missing.";case"not_found":return"This conversation does not exist or you do not have access to it.";case"load_failed":return n.error||"Unable to load the conversation. Please check your connection and try again.";default:return"An unexpected error occurred."}}),Q=g(()=>n.isSendingMessage),F=a=>a.participantTwoName||a.otherParticipantName||a.participantName||"Unknown User",A=a=>a.participantTwoId||null,B=async()=>{if(!M.value){f.value=!1;return}try{n.clearError(),k.value=null,n.conversations.length===0&&await n.fetchConversations();const a=n.conversations.find(h=>h.id===M.value);if(!a){f.value=!1;return}await n.fetchConversationMessages(M.value),await n.markConversationAsRead(M.value),n.setCurrentConversation(a)}catch(a){console.error("Error loading conversation data:",a)}finally{f.value=!1}},Y=async()=>{if(!p.value){p.value=!0,f.value=!0;try{await B()}finally{p.value=!1}}},c=async a=>{if(!(!x.value||!a.trim())){k.value=null;try{const h=A(x.value),X=await n.sendMessage(h,a.trim());X.success||(k.value=X.message||"Failed to send message")}catch(h){console.error("Error sending message:",h),k.value=h.message||"Failed to send message"}}},d=a=>{n.setCurrentConversation(a),l.push(`/chat/${a.id}`)},N=()=>l.push("/my-meetings"),z=()=>l.push({name:"user-dashboard",query:{focus:"calendar"}}),J=()=>l.push("/meetings"),oe=()=>l.push({name:"lawyer-dashboard",query:{focus:"calendar"}});return he(async()=>{if(!S.isLoggedIn){l.push("/login");return}await B(),m.value&&!$.value&&setTimeout(()=>{var a;return(a=m.value)==null?void 0:a.focusInput()},100)}),we(()=>{n.clearCurrentConversation(),k.value=null}),V(()=>M.value,async(a,h)=>{a!==h&&(f.value=!0,k.value=null,n.clearCurrentConversation(),await B())}),V(()=>n.error,a=>{a||(k.value=null)}),V(()=>E.value,a=>{document.title=a&&a!=="Unknown User"?`Chat with ${a} - LegalConnect`:"Chat - LegalConnect"},{immediate:!0}),(a,h)=>(i(),r("div",gt,[t("div",ht,[h[0]||(h[0]=t("div",{class:"sidebar-header"},[t("h3",null,"Conversations")],-1)),t("div",wt,[W(fe,{conversations:T.value,loading:y.value,onConversationClick:d},null,8,["conversations","loading"])])]),t("div",mt,[f.value?(i(),r("div",ft,[W(re,{type:"message-list",count:8,animated:!0})])):$.value?(i(),r("div",pt,[t("div",kt,[h[1]||(h[1]=t("svg",{class:"error-icon",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[t("path",{d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round","stroke-linejoin":"round"})],-1)),t("h2",null,R(H.value),1),t("p",null,R(K.value),1),t("div",yt,[t("button",{onClick:Y,class:"retry-btn",disabled:p.value},[p.value?(i(),r(L,{key:0},[D("Retrying...")],64)):(i(),r(L,{key:1},[D("Try Again")],64))],8,Ct)])])])):(i(),r("div",{key:2,class:"chat-messages",ref_key:"conversationContainerRef",ref:b,role:"region","aria-label":"Conversation messages"},[W(et,{"conversation-id":M.value,conversation:x.value,class:"conversation-view"},null,8,["conversation-id","conversation"])],512)),t("div",bt,[W(vt,{ref_key:"messageInputRef",ref:m,placeholder:`Message ${E.value}...`,"is-sending":Q.value,error:k.value,"max-rows":3,onSend:c},null,8,["placeholder","is-sending","error"])])]),t("div",Mt,[h[6]||(h[6]=t("div",{class:"actions-header"},[t("h4",null,"Quick Actions")],-1)),t("div",xt,[j.value?(i(),r(L,{key:0},[t("button",{onClick:N,class:"action-btn"},h[2]||(h[2]=[se('<div class="action-icon" data-v-18647370><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-18647370><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2" data-v-18647370></rect><path d="M3 9h18" stroke="currentColor" stroke-width="2" data-v-18647370></path><circle cx="8" cy="14" r="1.5" fill="currentColor" data-v-18647370></circle><circle cx="12" cy="14" r="1.5" fill="currentColor" data-v-18647370></circle><circle cx="16" cy="14" r="1.5" fill="currentColor" data-v-18647370></circle></svg></div><div class="action-text" data-v-18647370><span class="action-title" data-v-18647370>My Meetings</span><span class="action-subtitle" data-v-18647370>View and manage your meetings</span></div>',2)])),t("button",{onClick:z,class:"action-btn"},h[3]||(h[3]=[se('<div class="action-icon" data-v-18647370><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-18647370><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2" data-v-18647370></rect><path d="M7 2v4M17 2v4M3 9h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-v-18647370></path></svg></div><div class="action-text" data-v-18647370><span class="action-title" data-v-18647370>My Calendar</span><span class="action-subtitle" data-v-18647370>See your schedule</span></div>',2)]))],64)):G.value?(i(),r(L,{key:1},[t("button",{onClick:J,class:"action-btn"},h[4]||(h[4]=[se('<div class="action-icon" data-v-18647370><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-18647370><line x1="12" y1="5" x2="12" y2="19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-18647370></line><line x1="5" y1="12" x2="19" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-v-18647370></line></svg></div><div class="action-text" data-v-18647370><span class="action-title" data-v-18647370>Schedule Meeting</span><span class="action-subtitle" data-v-18647370>Create a new consultation</span></div>',2)])),t("button",{onClick:oe,class:"action-btn"},h[5]||(h[5]=[se('<div class="action-icon" data-v-18647370><svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-18647370><rect x="3" y="4" width="18" height="16" rx="2" stroke="currentColor" stroke-width="2" data-v-18647370></rect><path d="M7 2v4M17 2v4M3 9h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" data-v-18647370></path></svg></div><div class="action-text" data-v-18647370><span class="action-title" data-v-18647370>My Calendar</span><span class="action-subtitle" data-v-18647370>See your schedule</span></div>',2)]))],64)):_("",!0)])])]))}},Tt=ie(It,[["__scopeId","data-v-18647370"]]);export{Tt as default};
